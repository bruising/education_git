<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pengyipeng.education.mapper.ProjectDao">
    <select id="getProgect" resultMap="p">
        SELECT * FROM
        (select bb.*,aa.course_count from
        (SELECT p.id,p.project_no,p.`name`,p.intro,count(s.student_id) stu_count,p.create_date,p.flag FROM project p INNER JOIN project_student s ON p.id=s.project_id GROUP BY p.id) bb,
        (SELECT p.id,count(c.course_id) course_count FROM project p INNER JOIN course_project c ON p.id=c.project_id GROUP BY p.id) aa
        WHERE bb.id=aa.id) w
        <where>
            <if test="name!=null and name!=''">
                and w.name like concat('%',#{name},'%')
            </if>
            <if test="startDate!=null and startDate!='' and overDate!=null and overDate!=''">
                and w.create_date between #{startDate} and #{overDate}
            </if>
            <if test="flag!=null and flag!=''">
                and w.flag=#{flag}
            </if>

        </where>
        limit #{page},#{limit}

    </select>

    <select id="getCount" resultType="java.lang.Integer">
        SELECT count(*) FROM project
        <where>
            <if test="name!=null and name!=''">
                and name like concat('%',#{name},'%')
            </if>
            <if test="startDate!=null and startDate!='' and overDate!=null and overDate!=''">
                and create_date between #{startDate} and #{overDate}
            </if>
            <if test="flag!=null and flag!=''">
                and flag=#{flag}
            </if>

        </where>

    </select>

    <update id="updateFlag">
        update project set flag=#{flag} where id=#{id}
    </update>

    <update id="updateShowOrder">
        update project set show_order=#{showOrder} where id=#{id}
    </update>

    <resultMap id="p" type="com.pengyipeng.education.model.entity.Project">

            <id property="id" column="id"/>
            <result property="projectNo" column="project_no"/>
            <result property="applyPhaseId" column="apply_phase_id"/>
            <result property="img" column="img"/>
            <result property="name" column="name"/>
            <result property="intro" column="intro"/>
            <result property="codeId" column="code_id"/>
            <result property="stuCount" column="stu_count"/>
            <result property="courseCount" column="course_count"/>
            <result property="flag" column="flag"/>
            <result property="createDate" column="create_date"/>
            <result property="showOrder" column="show_order"/>


    </resultMap>

</mapper>